"use client";
import { useParams, useRouter, useSearchParams } from "next/navigation";
import { useEffect, useState, useCallback } from "react";
import PageHero from "@/components/PageHero";
import Section from "@/components/Section";
import Card from "@/components/Card";
import Button from "@/components/Button";
import Stat from "@/components/Stat";
import { getAnalysis, listAnalyses, updateProject } from "@/lib/projects";
import { buildAnalysisReportPDF } from "@/lib/reportPdf";

export default function ResultsPage() {
  const { id } = useParams();
  const search = useSearchParams();
  const analysisId = search.get("analysis");
  const router = useRouter();
  const [analysis, setAnalysis] = useState(null);
  const [projectMeta, setProjectMeta] = useState(null);
  const [printing, setPrinting] = useState(false);
  const [loading, setLoading] = useState(true);
  const [pdfUrl, setPdfUrl] = useState(null);
  const [generatingPdf, setGeneratingPdf] = useState(false);
  const [autoGenerated, setAutoGenerated] = useState(false);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        if (analysisId) {
          const doc = await getAnalysis(id, analysisId);
          if (!doc) throw new Error("Analysis not found");
          if (cancelled) return;
          const resultObj = doc.result || doc;
          setAnalysis(resultObj);
          const reportFile =
            resultObj.results?.report_summary?.report_files?.[0];
          const pdfCandidate = reportFile?.pdf_path || reportFile?._pdf || null;
          if (pdfCandidate) setPdfUrl(pdfCandidate);
        } else {
          const all = await listAnalyses(id);
          if (all.length) {
            const latest = all[all.length - 1];
            if (cancelled) return;
            const resultObj = latest.result || latest;
            setAnalysis(resultObj);
            const reportFile =
              resultObj.results?.report_summary?.report_files?.[0];
            const pdfCandidate =
              reportFile?.pdf_path || reportFile?._pdf || null;
            if (pdfCandidate) setPdfUrl(pdfCandidate);
          } else {
            const projects = JSON.parse(
              localStorage.getItem("dc_projects") || "{}"
            );
            const project = projects[id];
            setProjectMeta(project?.meta || null);
            if (project?.analysisResult) setAnalysis(project.analysisResult);
          }
        }
      } catch (e) {
        console.warn(e);
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [id, analysisId]);

  // Client-side PDF generation (professional template util)
  const generatePdfFromAnalysis = useCallback(async () => {
    if (!analysis || pdfUrl) return;
    setGeneratingPdf(true);
    try {
      const transparentPx =
        "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==";
      const doc = await buildAnalysisReportPDF({
        analysis,
        project: projectMeta,
        logoDataUrl: transparentPx,
        fallback: {
          total: 1773.09,
          intensity: 11.82,
          ci: 0.605,
          complianceScore: 0.375,
          complianceGrade: "F",
        },
      });
      const blob = doc.output("blob");
      const url = URL.createObjectURL(blob);
      setPdfUrl(url);
      setAutoGenerated(true);
      try {
        await updateProject(id, {
          hasReport: true,
          latestAnalysisId: analysisId || undefined,
        });
      } catch (e) {
        console.warn("Project flag update failed", e);
      }
    } catch (e) {
      console.warn("PDF generation failed", e);
    } finally {
      setGeneratingPdf(false);
    }
  }, [analysis, pdfUrl, projectMeta, id, analysisId]);

  // Auto-generate PDF when analysis present but no pdfUrl yet
  useEffect(() => {
    if (!loading && analysis && !pdfUrl && !generatingPdf) {
      generatePdfFromAnalysis();
    }
  }, [loading, analysis, pdfUrl, generatingPdf, generatePdfFromAnalysis]);

  // Print handler (opens PDF or triggers generation first)
  const handlePrint = useCallback(async () => {
    if (!analysis) return;
    if (!pdfUrl) {
      await generatePdfFromAnalysis();
    }
    if (pdfUrl) {
      window.open(pdfUrl, "_blank", "noopener,noreferrer");
    }
  }, [analysis, pdfUrl, generatePdfFromAnalysis]);

  // Defer derived computations until after loading guard to avoid null errors
  if (loading) {
    return (
      <Section>
        <p className="text-sm text-gray-600">Loading analysis…</p>
      </Section>
    );
  }

  if (!analysis) {
    return (
      <Section>
        <p className="text-sm text-gray-600">No analysis data available.</p>
      </Section>
    );
  }

  const lca = analysis?.results?.lca_summary || {};
  const compliance =
    analysis?.results?.compliance_summary ||
    analysis?.compliance_assessment ||
    {};
  const recommendations =
    analysis?.recommendations || analysis?.results?.recommendations || [];
  const charts = analysis?.charts_data || {};
  const benchmark =
    charts.benchmarking?.data ||
    analysis?.detailed_analysis?.benchmarking ||
    {};
  const circularity = analysis?.report_content?.circularity_metrics || {};
  const reportFile = analysis?.results?.report_summary?.report_files?.[0];
  const reportCircularity = reportFile?.circularity_metrics || {};
  const effectiveCircularity = Object.keys(reportCircularity).length
    ? reportCircularity
    : circularity;

  const stats = [
    {
      label: "Total Footprint (kg CO₂e)",
      value: (
        lca.total_carbon_footprint_kg_co2_eq ??
        analysis?.results?.carbon_footprint_kg_co2e ??
        0
      ).toFixed(2),
    },
    {
      label: "Intensity (kg CO₂e/kg)",
      value: (
        lca.carbon_intensity_per_kg ??
        analysis?.results?.carbon_intensity_per_kg ??
        0
      ).toFixed(3),
    },
    {
      label: "Circularity Index",
      value: (
        lca.circularity_index ??
        analysis?.results?.circularity_index ??
        0
      ).toFixed(3),
    },
    {
      label: "Compliance Score",
      value: (
        compliance.compliance_score ??
        compliance.overall_score ??
        0
      ).toFixed(2),
      note: compliance.compliance_grade || compliance.grade || "—",
    },
  ];

  return (
    <>
      <PageHero
        title="Results & Visualizations"
        description={
          projectMeta
            ? `Project: ${projectMeta.projectName}`
            : "Project Results"
        }
      />
      <Section>
        <div className="grid md:grid-cols-4 gap-6 mb-12">
          {stats.map((s, i) => (
            <Stat key={i} label={s.label} value={s.value} note={s.note} />
          ))}
        </div>
        <div className="grid lg:grid-cols-3 gap-6 mb-12">
          <Card className="p-6 space-y-3">
            <h3 className="font-semibold">Carbon Breakdown</h3>
            <ul className="text-sm space-y-1 text-gray-600">
              <li>
                Material:{" "}
                {analysis.report_content?.emissions_breakdown
                  ?.production_kg_co2e ?? "—"}
              </li>
              <li>
                Energy:{" "}
                {analysis.report_content?.emissions_breakdown?.energy_kg_co2e ??
                  "—"}
              </li>
              <li>
                Transport:{" "}
                {analysis.report_content?.emissions_breakdown
                  ?.transport_kg_co2e ?? "—"}
              </li>
              <li>
                End-of-Life:{" "}
                {analysis.report_content?.emissions_breakdown
                  ?.end_of_life_kg_co2e ?? "—"}
              </li>
            </ul>
          </Card>
          <Card className="p-6 space-y-3">
            <h3 className="font-semibold">Circularity</h3>
            <ul className="text-sm space-y-1 text-gray-600">
              <li>
                Recycled Content:{" "}
                {((effectiveCircularity.recycled_content || 0) * 100).toFixed(
                  1
                )}
                %
              </li>
              <li>
                Collection Rate:{" "}
                {((effectiveCircularity.collection_rate || 0) * 100).toFixed(1)}
                %
              </li>
              <li>
                Recycling Efficiency:{" "}
                {(
                  (effectiveCircularity.recycling_efficiency || 0) * 100
                ).toFixed(1)}
                %
              </li>
              <li>
                Output Circularity:{" "}
                {((effectiveCircularity.output_circularity || 0) * 100).toFixed(
                  1
                )}
                %
              </li>
              <li>Grade: {effectiveCircularity.circularity_grade || "—"}</li>
            </ul>
          </Card>
          <Card className="p-6 space-y-3">
            <h3 className="font-semibold">Compliance</h3>
            <ul className="text-sm space-y-1 text-gray-600">
              <li>
                Score:{" "}
                {(
                  compliance.compliance_score ??
                  compliance.overall_score ??
                  0
                ).toFixed(2)}
              </li>
              <li>
                Grade: {compliance.compliance_grade || compliance.grade || "—"}
              </li>
              <li>Status: {compliance.status || "—"}</li>
              <li>
                ISO 14040: {compliance.iso_14040_compliant ? "Yes" : "No"}
              </li>
              <li>
                ISO 14044: {compliance.iso_14044_compliant ? "Yes" : "No"}
              </li>
            </ul>
          </Card>
        </div>
        <Card className="p-6 mb-12">
          <h3 className="font-semibold mb-3">Recommendations</h3>
          <ul className="list-disc pl-5 text-sm text-gray-700 space-y-1">
            {recommendations.length ? (
              recommendations.map((r, i) => (
                <li key={i}>{r.recommendation || r.category || r}</li>
              ))
            ) : (
              <li>No recommendations</li>
            )}
          </ul>
        </Card>
        <Card className="p-6 mb-12">
          <h3 className="font-semibold mb-3">Technical Report PDF</h3>
          {pdfUrl ? (
            <div className="space-y-3">
              <div className="border rounded bg-gray-50 aspect-[3/4] w-full flex items-center justify-center overflow-hidden">
                <iframe
                  src={pdfUrl}
                  className="w-full h-full"
                  title="Report PDF"
                />
              </div>
              <div className="flex gap-3 flex-wrap items-center">
                <Button asChild>
                  <a href={pdfUrl} target="_blank" rel="noopener noreferrer">
                    {autoGenerated ? "Open Generated PDF" : "Open PDF"}
                  </a>
                </Button>
                <Button variant="outline" asChild>
                  <a href={pdfUrl} download>
                    {autoGenerated ? "Download Generated" : "Download"}
                  </a>
                </Button>
                {generatingPdf && (
                  <span className="text-xs text-gray-500">Building PDF…</span>
                )}
              </div>
            </div>
          ) : (
            <p className="text-sm text-gray-600">
              No PDF reference available. Generating summary PDF…
            </p>
          )}
        </Card>
        <div className="grid lg:grid-cols-2 gap-6 mb-12">
          <Card className="p-6">
            <h3 className="font-semibold mb-3">Benchmarking</h3>
            {Array.isArray(benchmark.values) ? (
              <table className="text-xs w-full">
                <thead>
                  <tr className="text-left">
                    <th className="py-1 pr-4">Category</th>
                    <th className="py-1">Value</th>
                  </tr>
                </thead>
                <tbody>
                  {benchmark.categories?.map((c, i) => (
                    <tr key={i} className="border-t">
                      <td className="py-1 pr-4">{c}</td>
                      <td className="py-1">{benchmark.values[i]}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            ) : (
              <pre className="text-xs bg-gray-50 p-3 rounded overflow-auto max-h-56">
                {JSON.stringify(benchmark, null, 2)}
              </pre>
            )}
          </Card>
          <Card className="p-6">
            <h3 className="font-semibold mb-3">Circularity Metrics JSON</h3>
            <pre className="text-xs bg-gray-50 p-3 rounded overflow-auto max-h-56">
              {JSON.stringify(circularity, null, 2)}
            </pre>
          </Card>
        </div>
        <Card className="p-6 mb-12">
          <h3 className="font-semibold mb-3">Raw Analysis JSON (Debug)</h3>
          <pre className="text-xs bg-gray-900 text-green-200 p-4 rounded overflow-auto max-h-[500px] whitespace-pre-wrap">
            {JSON.stringify(analysis, null, 2)}
          </pre>
        </Card>
        <div className="flex flex-wrap gap-4">
          <Button onClick={handlePrint}>
            {printing ? "Preparing..." : "Print / Save"}
          </Button>
          <Button
            variant="outline"
            onClick={() =>
              router.push(
                analysisId
                  ? `/projects/${id}/analysis?analysis=${analysisId}`
                  : `/projects/${id}/analysis`
              )
            }
          >
            Summary View
          </Button>
          <Button variant="outline" onClick={() => router.push(`../upload`)}>
            Edit Inputs
          </Button>
          <Button
            variant="secondary"
            onClick={() => router.push(`/projects/new`)}
          >
            New Project
          </Button>
        </div>
      </Section>
    </>
  );
}
